xcrake
=======

A Rakefile to build iOS projects. Get the latest [here](https://github.com/willowtreeapps/xcrake/releases/). If you're having issues with the setup and are stuck having to use sudo or are unable to install certain gems, please read [this](https://gist.github.com/andrewroycarter/6815905) in order to setup a good cocoapods environment.

#Features

* Supports [Cocoapods](http://cocoapods.org)
* Builds projects or workspaces
* Simple [YAML](http://yaml.org) configuration file
* Supports [TestFlight](http://testflightapp.com) uploading
* Re-signs a single .app file for all generated ipas
* Can easily be run locally and remotely for easy debugging
* Installs committed provisioning profiles for building
* Can resign using committed provisioning profiles without installing the profile
* Supports using custom build tools (like [xctool](https://github.com/facebook/xctool))

# Usage

## Tasks

The tasks that the Rakefile is able to perform and generated based off of your config file. To see a list of all possible tasks and their description, run `bundle exec rake --tasks`. A sample output would be:
```shell
xcrake version: 1.0.0
rake .xcrake                            # Create build output folder
rake artifacts                          # Create artifacts output folder
rake artifacts/Green-release.app        # Create artifacts/Green-release.app
rake artifacts/Red-release.app          # Create artifacts/Red-release.app
rake artifacts/green.ipa                # Build green
rake artifacts/red.ipa                  # Build red
rake clean                              # Cleans build folder
rake config:create                      # Create template xcrake.config file
rake debug:print_environment            # Prints shell environment variables
rake pod:clean                          # Remove Pods/ dir
rake pod:install                        # Install pods in Podfile
rake testflight:all                     # Upload all builds to TestFlight
rake testflight:green                   # Upload green to TestFlight
rake testflight:red                     # Upload red to TestFlight
```

## General Use Case

* Add `.xcrake/` and `artifacts` to your `.gitignore` file
* Copy the `Rakefile` into your projects directory
	* Get the latest [here](https://github.com/willowtreeapps/xcrake/releases/). For instructions on building the Rakefile yourself, read [Building](#building)
* Ensure that your Gemfile exists and includes all required gems. Here's an example [Gemfile](Gemfile)
* Run `bundle install` to ensure all gems have been installed.
* Run `bundle exec rake config:create` to create a template `xcrake.config` file.
	* The template `xcrake.config` contains all the keys needed to build a build. If you're having trouble with the YAML, read up on it [here](http://www.yaml.org/spec/1.2/spec.html) or read a [TL;DR](http://www.yaml.org/start.html) of the format.
* Run `bundle exec rake`. If everything goes right you'll end up with a new `artifacts` directory in your project which contains
	1. `SchemeName-ConfigurationName.app` the .app file for your project
	2. `SchemeName-ConfigurationName.app.dSYM.zip` the dSYM for the build (zipped)
	3. `BuildName.ipa` your app signed and packaged with the WillowTree In-House Certificate
	4. Any other .ipas for other specified configurations

# The xcrake.config File

```YAML
builds:
  -
    name: # Name for built ipa
    scheme: # Scheme name to build
    bundle_id: # Bundle id to set in info plist
    provisioning_profile: # UUID of provisioning profile to sign with
    signing_identity: # Signing identity name
    signing_identity_SHA1: # Signing identity SHA1
    configuration: # Build configuration to use
    # testflight_team_token: # Team token for TestFlight uploads
    # testflight_api_token: # API token for TestFlight uploads
    # testflight_distribution_lists: # Distribution list for TestFlight uploads
# artifacts_path: # Custom path for built ipa / app / dsym files
# build_path: # Custom path for temporary build files
# profiles_path: # Custom path for provisioning profiles
# build_tool: # Custom build tool to use (for example xctool)
# additional_build_options: # Options to be used during build
```

* If the provisioning profile exists in `profiles_path`, it will be install or used from there as needed
* The `signing_identity_SHA1` can be found by right clicking the certificate in keychain and clicking "get info". 
* A template `xcrake.config` file can be generated by running `rake config:create`

# Setting up on TeamCity

* Create a new Build Configuration
* Set __Artifact Paths__ to `artifacts/**`
* Add your Version Control Settings
* Add Bundle Install Build Step
	* Add a Command Line Build Step
	* Name build step Bundle Install
	* Run Custom Script `bundle install`
* Add Rake Build Step
	* Add a Rake Build Runner Step
	* Name build step Rake Build
	* Make sure `bundle exec` checkmark under __Bundler__ is checked
	* If you want verbose information check `Track invoke/execute stages` under __Debug__
	* Make sure all `Attached Reporters` are unchecked under __Tests Reporting__
* Add a Rake Build Step for TestFlight (Optional)
	* Add a Rake Build Runner Step
	* Name build step Testflight
	* For __Rake tasks:__ put `testflight:all` or `testflight:buildname` depending on which builds you want to submit to TestFlight
	* Make sure `bundle exec` checkmark under __Bundler__ is checked
	* If you want verbose information check `Track invoke/execute stages` under __Debug__
	* Make sure all `Attached Reporters` are unchecked under __Tests Reporting__
* Make sure that it's running on an Xcode 5 capable server with `bundler` and `libxml2` installed
* If the environment variable `BUILD_NUMBER` is set during a build, it will be appended to the `CFBundleVersion`. Build servers like TeamCity are able to set this for you. If you'd like to set it yourself manually, you can pass it into the `Rakefile` by running `rake BUILD_NUMBER=2`

# Building

To build the Rakefile
```shell
# clone the git repo
git clone https://github.com/willowtreeapps/xcrake.git

# change directory into the cloned project
cd xcrake

# running make will execute the Makefile
# this will create build/Rakefile
make
```

You can now copy `xcrake/build/Rakefile` into your projects directory. 

# Debugging / Development

To make the development process easier, you can symlink the `Rakefile` built by [make](http://www.gnu.org/software/make/) in your projects directory. Running `make` after making changes to `xcrake/Rakefile` or `xcrake/rakelib/*.rake` will cause `xcrake/build/Rakefile` to be rebuilt. If you'd rather not have to run `make` after making changes, you can symlink `xcrake/Rakefile` and `xcrake/rakelib` in your projects directory.

```shell
# To symlink the built Rakefile
ln -s /path/to/xcrake/build/Rakefile /path/to/MyProject/

# To symlink without having to rebuild
ln -s /path/to/xcrake/Rakefile /path/to/MyProject/
ln -s /path/to/xcrake/rakelib /path/to/MyProject/

```

Do keep in mind that when committing to be built on the build server, you'll need the built Rakefile in your projects directory- __not__ the symlinks.

# Special Thanks

* Thanks to [Timothy Perfitt](https://twitter.com/tperfitt) for his write-up on [re-signining iOS apps](http://www.afp548.com/2012/06/05/re-signining-ios-apps/)
* Thanks to [Matt Yohe](https://twitter.com/mattyohe) for his wisdom on how Xcode builds work
* Thanks to [Miles Matthias](https://twitter.com/nowmiles) for his [TestFlight](https://github.com/milesmatthias/testflight_upload/blob/master/lib/testflight_upload.rb) uploading script, which was used for reference in the TestFlight upload task


# License (MIT)
```
Copyright (c) 2013 WillowTree Apps

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
```

# Testimonials

* _It's just fabulous_ - Matt Jones
* _Incredibly easy_ - Jeff Gordan
